<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Milk T : VOC Management System</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    
    <style>
        :root {
            /* [ì²œì¬êµìœ¡ & ë°€í¬T ë¸Œëœë“œ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸] */
            --brand-primary: #0085CA;       /* ì²œì¬êµìœ¡ ë©”ì¸ ë¸”ë£¨ */
            --brand-secondary: #00C6ED;     /* ë°€í¬T ì‹œê·¸ë‹ˆì²˜ ì‹œì•ˆ(Cyan) */
            --brand-dark: #1A2B45;          /* ì „ë¬¸ì ì¸ ë”¥ ë„¤ì´ë¹„ (í—¤ë”ìš©) */
            
            --ui-bg: #EAECEF;               /* ì°¨ë¶„í•œ íšŒìƒ‰ ë°°ê²½ */
            --ui-surface: #FFFFFF;
            
            --line-strong: #BDC3C7;         /* ì§„í•œ ê²½ê³„ì„  */
            --line-light: #E0E0E0;
            
            --text-main: #2C3E50;
            --text-sub: #5D6D7E;
            
            --state-danger: #E74C3C;        /* ê²½ê³  (ì„ ëª…í•œ ë¹¨ê°•) */
            --state-danger-bg: #FDEDEC;
            --state-success: #27AE60;       /* ì •ìƒ (ì„ ëª…í•œ ì´ˆë¡) */
            --state-success-bg: #EAFAF1;
            
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--ui-bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 1. GNB (Global Navigation Bar) --- */
        header {
            height: var(--header-height);
            background-color: var(--brand-dark);
            border-bottom: 4px solid var(--brand-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            color: white;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-symbol {
            width: 32px;
            height: 32px;
            background: var(--brand-secondary);
            color: var(--brand-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.4rem;
            font-family: sans-serif;
            border-radius: 0; 
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.9rem;
        }

        .user-tag {
            background: #000;
            color: var(--brand-secondary);
            padding: 4px 8px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        /* --- 2. Main Layout --- */
        .layout-wrapper {
            display: flex;
            height: calc(100vh - var(--header-height));
            width: 100%;
            padding: 16px;
            gap: 16px;
        }

        .panel {
            background: var(--ui-surface);
            border: 1px solid var(--line-strong);
            display: flex;
            flex-direction: column;
            box-shadow: none; 
        }

        /* --- ì¢Œì¸¡: ì—ë””í„° ì˜ì—­ --- */
        .left-panel {
            flex: 5;
            min-width: 400px;
        }

        .panel-header {
            background: #F4F6F7;
            padding: 12px 16px;
            border-bottom: 1px solid var(--line-strong);
            font-weight: 700;
            color: var(--brand-dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .panel-header::before {
            content: '';
            display: block;
            width: 4px;
            height: 16px;
            background: var(--brand-primary);
        }

        .editor-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--line-light);
            color: var(--text-sub);
            font-size: 0.85rem;
        }
        
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .input-area {
            flex: 1;
            width: 100%;
            border: 1px solid var(--line-light);
            padding: 20px;
            font-size: 1.05rem;
            line-height: 1.8;
            outline: none;
            resize: none;
            background-color: #FAFAFA;
            color: #000;
            border-radius: 0; 
        }

        .input-area:focus {
            background-color: #fff;
            border-color: var(--brand-primary);
            box-shadow: inset 3px 0 0 var(--brand-primary);
        }

        .highlight-complaint {
            color: var(--state-danger);
            font-weight: 900;
            background-color: rgba(231, 76, 60, 0.1);
            border-bottom: 2px solid var(--state-danger);
            padding: 0 2px;
        }

        /* --- ìš°ì¸¡: ë¶„ì„ ëŒ€ì‹œë³´ë“œ --- */
        .right-panel {
            flex: 5;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: transparent;
            border: none;
        }

        .status-panel {
            flex: 0 0 auto;
            background: var(--ui-surface);
            border: 1px solid var(--line-strong);
            padding: 16px;
        }

        .result-row {
            display: flex;
            align-items: stretch;
            gap: 12px;
        }

        .result-badge {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            font-weight: 700;
            font-size: 1rem;
            border: 1px solid;
            border-radius: 0;
            text-transform: uppercase;
        }

        .result-badge.normal {
            background: var(--state-success-bg);
            border-color: var(--state-success);
            color: var(--state-success);
        }

        .result-badge.complaint {
            background: var(--state-danger-bg);
            border-color: var(--state-danger);
            color: var(--state-danger);
        }

        .detected-keywords {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--line-strong);
            display: none;
        }
        
        .keyword-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-sub);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .keyword-chip {
            display: inline-block;
            background: #fff;
            border: 1px solid var(--state-danger);
            color: var(--state-danger);
            padding: 4px 8px;
            margin-right: 6px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
        }
        .keyword-chip:hover {
            background: var(--state-danger);
            color: #fff;
        }

        .keyword-desc {
            margin-top: 8px;
            background: #2C3E50;
            color: #fff;
            padding: 8px 12px;
            font-size: 0.85rem;
            display: none;
        }

        .recommendation-panel {
            flex: 1;
            background: var(--ui-surface);
            border: 1px solid var(--line-strong);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .rec-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .top5-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
            border: 1px solid var(--line-strong);
        }
        
        .top5-table th, .top5-table td {
            padding: 12px 14px;
            border: 1px solid var(--line-light);
            font-size: 0.9rem;
            text-align: left;
            position: relative;
        }
        
        .top5-table th {
            background: #F8F9F9;
            color: var(--text-sub);
            font-weight: 600;
            text-align: center;
        }

        .top5-row {
            cursor: pointer;
            transition: background 0.1s;
        }
        .top5-row:hover {
            background: #F4F6F7;
        }
        .top5-row.rank-1 {
            background: #EBF5FB;
            font-weight: 700;
        }
        .top5-row.rank-1 td {
            border-top: 2px solid var(--brand-primary);
            border-bottom: 2px solid var(--brand-primary);
            color: var(--brand-primary);
        }

        .score-num {
            font-family: 'Consolas', monospace;
            font-weight: 700;
            text-align: right;
        }

        .score-tooltip {
            display: none;
            position: absolute;
            top: 40px;
            left: 10px;
            background: #eef4f8;
            border: 1px solid #0085CA;
            padding: 8px 12px;
            z-index: 100;
            font-size: 0.85rem;
            color: #2C3E50;
            font-weight: normal;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            white-space: nowrap;
            pointer-events: none;
        }
        
        .score-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 20px;
            border-width: 0 6px 6px 6px;
            border-style: solid;
            border-color: transparent transparent #0085CA transparent;
        }

        .top5-row:hover .score-tooltip {
            display: block;
        }

        .cat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--line-light);
            border: 1px solid var(--line-light);
        }

        .cat-btn {
            background: #fff;
            padding: 12px 4px;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60px;
        }

        .cat-btn:hover {
            background: #F2F3F4;
            color: #000;
        }

        .cat-btn.highlighted {
            color: var(--brand-primary);
            font-weight: 700;
            background: #EBF5FB;
        }

        .cat-btn.selected {
            background: var(--brand-dark);
            color: var(--brand-secondary);
            font-weight: 700;
        }

        .sub-cat-wrapper {
            margin-top: 16px;
            border: 1px solid var(--line-strong);
            background: #fff;
            display: none;
        }
        
        .sub-cat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 16px;
            border-bottom: 1px solid var(--line-light);
            font-size: 0.9rem;
            color: #1A2B45; 
        }
        .sub-cat-row:last-child { border-bottom: none; }
        
        .sub-cat-row.active {
            background: #f0f8ff;
            font-weight: 700;
        }

        .sub-cat-score {
            font-family: 'Consolas', monospace;
            font-weight: 700;
            color: var(--brand-primary);
        }
        
        .sub-cat-score.zero {
            color: #D5D8DC;
            font-weight: 400;
        }

        .empty-placeholder {
            text-align: center;
            padding: 40px;
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        .footer-bar {
            background: #2C3E50;
            color: #95A5A6;
            padding: 4px 16px;
            font-size: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .hidden-badge { color: var(--state-danger); font-weight: 900; margin-left: 4px; }
        .breadcrumb { display: flex; align-items: center; gap: 4px; }
        .sep { color: var(--line-strong); font-size: 0.8rem; }

        /* [ìš”ì²­ë°˜ì˜ 1] ì„¤ì¹˜ íŒì—… ìŠ¤íƒ€ì¼ (ì›ë³¸ ìŠ¤íƒ€ì¼ ë³µêµ¬) */
        #installPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid var(--brand-primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            text-align: center;
            width: 300px;
        }
        #installPopup p {
            margin-top: 0;
            color: var(--text-main);
            font-weight: 700;
        }
        #installPopup button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 500;
        }
        #confirmInstall {
            background: var(--brand-primary);
            color: white;
        }
        #cancelInstall {
            background: #ccc;
            color: #333;
        }

        @media (max-width: 1024px) {
            .layout-wrapper { flex-direction: column; overflow-y: auto; height: auto; }
            .left-panel, .right-panel { flex: none; width: 100%; min-width: 0; }
            .input-area { min-height: 200px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand-logo">
            <div class="logo-symbol">T</div>
            <span style="margin-left:8px;">Genius VOC System</span>
        </div>
        <div class="user-info">
            <span class="material-icons-sharp" style="font-size:18px;">support_agent</span>
            <span>ê³ ê°ìƒë‹´íŒ€ | ê¹€ì²œì¬ ë§¤ë‹ˆì €</span>
            <span class="user-tag">ADMIN</span>
        </div>
    </header>

    <div class="layout-wrapper">
        
        <section class="panel left-panel">
            <div class="panel-header">
                <span class="material-icons-sharp" style="font-size:18px; color:var(--text-sub);">edit_note</span>
                ìƒë‹´ ë‚´ìš© ê¸°ë¡ (Transcript)
            </div>
            <div class="editor-container">
                <div class="editor-toolbar">
                    <div class="toolbar-item">
                        <span class="material-icons-sharp" style="font-size:16px;">history</span>
                        <span>ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘ (Auto-Analysis On)</span>
                    </div>
                </div>
                <div id="inputArea" class="input-area" contenteditable="true" spellcheck="false" data-placeholder="[ìƒë‹´ ì‹œì‘] ê³ ê°ë‹˜ì˜ ë¬¸ì˜ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”."></div>
            </div>
        </section>

        <section class="right-panel">
            
            <div class="status-panel">
                <div id="resultBox" style="display:none;" class="result-row"></div>
                <div id="initialComplaintMessage" class="result-badge" style="background:#F2F3F4; border-color:#BDC3C7; color:#7F8C8D;">
                    <span class="material-icons-sharp">hourglass_empty</span>
                    <span>ìƒë‹´ ë‚´ìš© ì…ë ¥ ëŒ€ê¸°</span>
                </div>

                <div id="keywordsBox" class="detected-keywords">
                    <div class="keyword-label">
                        <span class="material-icons-sharp" style="font-size:14px; color:var(--state-danger);">error</span>
                        ê°ì§€ëœ ë¶ˆë§Œ í‚¤ì›Œë“œ (VOC Issues)
                    </div>
                    <div id="keywordList"></div>
                    <div id="keywordDesc" class="keyword-desc"></div>
                </div>
            </div>

            <div class="recommendation-panel">
                <div class="panel-header">
                    <span class="material-icons-sharp" style="font-size:18px; color:var(--text-sub);">psychology</span>
                    AI ì¶”ì²œ ìœ í˜• (Smart Suggestion)
                </div>
                
                <div class="rec-content">
                    <div id="top5Block" style="display:none;">
                        <table class="top5-table">
                            <thead>
                                <tr>
                                    <th width="15%">ìˆœìœ„</th>
                                    <th>ìƒë‹´ ìœ í˜• (ëŒ€ë¶„ë¥˜ > ìƒì„¸)</th>
                                    <th width="20%">ì í•©ë„</th>
                                </tr>
                            </thead>
                            <tbody id="top5Container">
                                </tbody>
                        </table>
                    </div>

                    <div id="groupedRecommendations">
                        <div class="empty-placeholder">
                            <span class="material-icons-sharp" style="font-size:48px; color:#D5D8DC;">assignment_turned_in</span>
                            <br><br>
                            í…ìŠ¤íŠ¸ ë¶„ì„ í›„<br>ìµœì ì˜ ìƒë‹´ ìœ í˜•ì„ í‘œì‹œí•©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <div id="securityBanner" class="footer-bar">
        <span class="material-icons-sharp" style="font-size:12px;">lock</span>
        CHUNJAE EDUCATION INC. INTERNAL USE ONLY.
    </div>

    <div id="installPopup">
        <p style="font-size:1.1em; margin-bottom:15px;">ğŸ“² ì´ ì•±ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <button id="confirmInstall">ì„¤ì¹˜</button>
        <button id="cancelInstall">ì·¨ì†Œ</button>
    </div>

    <script src="data.js"></script>

    <script>
        // =========================================================
        //  [ë¡œì§] data ê°ì²´ëŠ” data.jsì—ì„œ ë¶ˆëŸ¬ì˜¤ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì„ ì–¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // =========================================================

        const inputArea = document.getElementById('inputArea');
        const resultBox = document.getElementById('resultBox'); // flex row container
        const initialMsg = document.getElementById('initialComplaintMessage');
        const groupedRecommendations = document.getElementById('groupedRecommendations');
        const keywordsBox = document.getElementById('keywordsBox');
        const keywordList = document.getElementById('keywordList');
        const keywordDescBox = document.getElementById('keywordDesc');
        const top5Container = document.getElementById('top5Container');
        
        // ë°ì´í„° (ê¸°ì¡´ ìœ ì§€)
        const complaintKeywords = [
            "ë¶ˆë§Œ", "ë¶ˆì¾Œ", "í•­ì˜", "ì§œì¦", "ì‹¤ë§", "ë¶ˆì¹œì ˆ", "ê¸°ë¶„ ë‚˜ë¹´", "ì–¸ì§¢", "ë¬´ë¡€", "ë¶€ë‹¹",
            "ê¸°ë¶„ ìƒí–ˆ", "ê°•ì„±", "ì‹ ê³ ", "ê²½ì°°", "ì†Œë³´ì›", "ì†Œë¹„ìë³´í˜¸ì›", "ì†Œë¹„ì ë³´í˜¸ì›",
            "ìš•ì„¤", "ìµœì•…", "ë²•ì ëŒ€ì‘"
        ];
        const keywordDescriptions = {
            "ë¶ˆë§Œ": "ì„œë¹„ìŠ¤ë‚˜ ì œí’ˆì— ëŒ€í•œ ì „ë°˜ì ì¸ ë¶ˆë§Œ í‘œí˜„ì…ë‹ˆë‹¤.",
            "ë¶ˆì¾Œ": "ê³ ê°ì´ ê¸°ë¶„ì´ ìƒí•˜ê±°ë‚˜ ë¶ˆì¾Œê°ì„ ëŠë‚€ ìƒí™©ì…ë‹ˆë‹¤.",
            "í•­ì˜": "ë¬¸ì œ ì œê¸°ì™€ í•¨ê»˜ ì‹œì • ìš”êµ¬ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
            "ì§œì¦": "ë¶ˆí¸Â·ë¶ˆë§Œì´ ê°ì •ì ìœ¼ë¡œ í‘œì¶œëœ ìƒíƒœì…ë‹ˆë‹¤.",
            "ì‹¤ë§": "ê¸°ëŒ€ì— ë¯¸ì¹˜ì§€ ëª»í•´ ë¶€ì •ì  í‰ê°€ë¥¼ í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ë¶ˆì¹œì ˆ": "ì‘ëŒ€ íƒœë„ë‚˜ ì„œë¹„ìŠ¤ ë§¤ë„ˆì— ëŒ€í•œ ë¶€ì •ì  í”¼ë“œë°±ì…ë‹ˆë‹¤.",
            "ê¸°ë¶„ ë‚˜ë¹´": "ë°œì–¸Â·í–‰ë™ìœ¼ë¡œ ì¸í•´ ê°ì •ì´ ìƒí•œ ìƒíƒœì…ë‹ˆë‹¤.",
            "ì–¸ì§¢": "ì‚¬ì†Œí•´ ë³´ì´ì§€ë§Œ ë¶ˆë§Œìœ¼ë¡œ ë²ˆì§ˆ ìˆ˜ ìˆëŠ” ê°ì • í‘œí˜„ì…ë‹ˆë‹¤.",
            "ë¬´ë¡€": "ì˜ˆì˜ ì—†ëŠ” íƒœë„ë‚˜ ë°œì–¸ì— ëŒ€í•œ ì§€ì ì…ë‹ˆë‹¤.",
            "ë¶€ë‹¹": "ë¶ˆê³µì •Â·ë¶€ì •í™•í•œ ì²˜ë¦¬ì— ëŒ€í•œ ë¬¸ì œ ì œê¸°ì…ë‹ˆë‹¤.",
            "ê¸°ë¶„ ìƒí–ˆ": "ê³ ê° ê°ì •ì´ í¬ê²Œ ìƒí•œ ìƒíƒœë¡œ, ì§„ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.",
            "ê°•ì„±": "ê°•ê²½í•œ ì–´ì¡°ë¡œ ë¶ˆë§Œì„ ì œê¸°í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì‹ ê³ ": "ì™¸ë¶€ ê¸°ê´€ì— ë¬¸ì œë¥¼ ì•Œë¦¬ê² ë‹¤ëŠ” ì˜ì‚¬ í‘œí˜„ì…ë‹ˆë‹¤.",
            "ê²½ì°°": "ë²•ì Â·í˜•ì‚¬ì  ì¡°ì¹˜ë¥¼ ì•”ì‹œí•˜ëŠ” ë°œì–¸ì…ë‹ˆë‹¤.",
            "ì†Œë³´ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì†Œë¹„ìë³´í˜¸ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì†Œë¹„ì ë³´í˜¸ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ìš•ì„¤": "ë¶€ì ì ˆí•œ ì–¸ì–´ ì‚¬ìš©ìœ¼ë¡œ ê°ì •ì´ ê²©í•´ì§„ ìƒíƒœì…ë‹ˆë‹¤.",
            "ìµœì•…": "ë§¤ìš° ê°•í•œ ë¶€ì • í‰ê°€ë¡œ, ë¶ˆë§Œ ê°•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.",
            "ë²•ì ëŒ€ì‘": "ë²•ì  ì ˆì°¨ë¥¼ ì§„í–‰í•˜ê² ë‹¤ëŠ” ì˜ì‚¬ í‘œí˜„ì…ë‹ˆë‹¤."
        };

        // data ë³€ìˆ˜ëŠ” data.jsì—ì„œ ë¡œë“œë¨

        const parsedData = data.types.map(type => ({
            ...type,
            allKeywords: [...type.superMainKeywords, ...type.mainKeywords, ...type.generalKeywords]
        }));
        const globalWeights = data.weights;

        const documentFrequency = {};
        const totalDocuments = parsedData.length;
        const allUniqueWords = [...new Set(parsedData.flatMap(doc => doc.allKeywords))];
        allUniqueWords.forEach(word => {
            documentFrequency[word] = parsedData.filter(doc => doc.allKeywords.includes(word)).length;
        });
        const idfScores = {};
        allUniqueWords.forEach(word => {
            idfScores[word] = Math.log10(totalDocuments / ((documentFrequency[word] || 0) + 1));
        });

        let isComposing = false;
        
        inputArea.addEventListener('compositionstart', () => { isComposing = true; });
        inputArea.addEventListener('compositionend', () => {
            isComposing = false;
            processInput();
        });
        inputArea.addEventListener('input', () => {
            if (!isComposing) processInput();
        });
        inputArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isComposing) {
                e.preventDefault();
                document.execCommand('insertLineBreak');
                processInput();
            }
        });

        function processInput() {
            const text = inputArea.textContent.trim();
            highlightKeywords();
            recommendType();
            updatePlaceholder();

            if (text.length === 0) {
                // ì´ˆê¸° ìƒíƒœ
                initialMsg.style.display = 'flex';
                resultBox.style.display = 'none';
                keywordsBox.style.display = 'none';
            } else {
                initialMsg.style.display = 'none';
            }
        }

        function updatePlaceholder() {
            if (inputArea.textContent.trim() === '') {
                inputArea.setAttribute('data-placeholder', '[ìƒë‹´ ì‹œì‘] ê³ ê°ë‹˜ì˜ ë¬¸ì˜ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”.');
            } else {
                inputArea.removeAttribute('data-placeholder');
            }
        }

        function highlightKeywords() {
            if (!inputArea.textContent.trim()) {
                inputArea.innerHTML = '';
                updateUIForNormalState();
                return;
            }

            const currentSelection = window.getSelection();
            const currentRange = currentSelection.rangeCount > 0 ? currentSelection.getRangeAt(0) : null;
            const currentOffset = currentRange ? getCaretCharacterOffsetWithin(inputArea) : null;
            
            const text = inputArea.textContent;
            let newHtml = '';
            let lastIndex = 0;
            let keywordCounts = {};

            const matches = Array.from(text.matchAll(new RegExp(`(${complaintKeywords.join('|')})`, 'gi')));
            
            if (matches.length > 0) {
                matches.sort((a, b) => a.index - b.index);
                for (const match of matches) {
                    const keyword = match[0];
                    const index = match.index;
                    if (index >= lastIndex) {
                        newHtml += text.substring(lastIndex, index);
                        newHtml += `<span class="highlight-complaint">${keyword}</span>`;
                        lastIndex = index + keyword.length;
                        keywordCounts[keyword] = (keywordCounts[keyword] || 0) + 1;
                    }
                }
                newHtml += text.substring(lastIndex);
            } else {
                newHtml = text;
            }

            inputArea.innerHTML = newHtml;

            if (currentRange) {
                setCaretPosition(inputArea, currentOffset);
            }
            
            if (Object.keys(keywordCounts).length > 0) {
                const totalCount = Object.values(keywordCounts).reduce((sum, count) => sum + count, 0);
                updateUIForComplaintState(keywordCounts, totalCount);
            } else {
                updateUIForNormalState();
            }
        }

        function getCaretCharacterOffsetWithin(element) {
            let caretOffset = 0;
            const doc = element.ownerDocument || element.document;
            const win = doc.defaultView || doc.parentWindow;
            const sel = win.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;
            }
            return caretOffset;
        }

        function setCaretPosition(element, offset) {
            const doc = element.ownerDocument || element.document;
            const win = doc.defaultView || doc.parentWindow;
            const sel = win.getSelection();
            let currentOffset = 0;
            let found = false;
            function traverse(node) {
                if (found) return;
                if (node.nodeType === Node.TEXT_NODE) {
                    const nextOffset = currentOffset + node.length;
                    if (offset <= nextOffset) {
                        const range = doc.createRange();
                        range.setStart(node, offset - currentOffset);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        found = true;
                    }
                    currentOffset = nextOffset;
                } else {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        traverse(node.childNodes[i]);
                        if (found) break;
                    }
                }
            }
            traverse(element);
        }

        /* --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ --- */
        function updateUIForComplaintState(keywordCounts, totalCount) {
            resultBox.innerHTML = `
                <div class="result-badge complaint">
                    <span class="material-icons-sharp">report_problem</span>
                    <span>ë¶ˆë§Œ í‘œí˜„ ê°ì§€ë¨ (RISK)</span>
                </div>
            `;
            resultBox.style.display = 'flex';

            keywordsBox.style.display = 'block';
            keywordList.innerHTML = '';
            
            const foundKeywords = Object.keys(keywordCounts);
            foundKeywords.forEach(k => {
                const span = document.createElement('span');
                span.className = 'keyword-chip';
                span.innerText = `${k} (${keywordCounts[k]})`;
                span.addEventListener('click', () => {
                    keywordDescBox.innerHTML = `<strong style="color:var(--state-danger);">[${k}]</strong> : ${keywordDescriptions[k] || 'ì„¤ëª… ì—†ìŒ'}`;
                    keywordDescBox.style.display = 'block';
                });
                keywordList.appendChild(span);
            });
            keywordDescBox.style.display = 'none';
        }
        
        function updateUIForNormalState() {
            resultBox.innerHTML = `
                <div class="result-badge normal">
                    <span class="material-icons-sharp">verified</span>
                    <span>ìƒë‹´ ë‚´ìš© ì •ìƒ (NORMAL)</span>
                </div>
            `;
            resultBox.style.display = 'flex';

            keywordsBox.style.display = 'none';
            keywordList.innerHTML = '';
            keywordDescBox.style.display = 'none';
        }
        
        // --- ì¶”ì²œ ë¡œì§ ---
        let selectedMainType = null;
        
        function recommendType() {
            const text = inputArea.textContent.trim().toLowerCase().replace(/\s+/g, '');
            top5Container.innerHTML = '';
            
            const hasComplaintKeyword = complaintKeywords.some(k => text.includes(k));
            let recommendations = [];

            data.types.forEach(type => {
                const currentWeights = type.weights || globalWeights;
                const { superMainKeywordWeight, mainKeywordWeight, generalKeywordBonus } = currentWeights;
                let score = 0;
                let matchedKeywords = [];
                let hiddenType = null;

                type.superMainKeywords.forEach(keyword => {
                    if (text.includes(keyword.toLowerCase())) {
                        const keywordScore = superMainKeywordWeight + (idfScores[keyword] || 0);
                        score += keywordScore;
                        matchedKeywords.push({ keyword, score: keywordScore, type: 'superMain' });
                    }
                });
                type.mainKeywords.forEach(keyword => {
                    if (text.includes(keyword.toLowerCase())) {
                        const keywordScore = mainKeywordWeight + (idfScores[keyword] || 0);
                        score += keywordScore;
                        matchedKeywords.push({ keyword, score: keywordScore, type: 'main' });
                    }
                });
                type.generalKeywords.forEach(keyword => {
                    if (text.includes(keyword.toLowerCase()) && !matchedKeywords.some(mk => mk.keyword.toLowerCase() === keyword.toLowerCase())) {
                        score += generalKeywordBonus;
                        matchedKeywords.push({ keyword, score: generalKeywordBonus, type: 'general' });
                    }
                });
                recommendations.push({ ...type, score: score, matchedKeywords: matchedKeywords, hiddenType: null });
            });

            if (hasComplaintKeyword) {
                recommendations.forEach(recommendation => {
                    let hiddenKeywordsList = null;
                    if (recommendation.hiddenKeywordRef) hiddenKeywordsList = data.commonHiddenKeywords[recommendation.hiddenKeywordRef];
                    else if (recommendation.hiddenKeywords) hiddenKeywordsList = recommendation.hiddenKeywords;

                    let allHiddenKeywords = [];
                    if (Array.isArray(hiddenKeywordsList)) allHiddenKeywords = allHiddenKeywords.concat(hiddenKeywordsList);
                    if (Array.isArray(recommendation.exceptionHiddenKeywords)) allHiddenKeywords = allHiddenKeywords.concat(recommendation.exceptionHiddenKeywords);

                    if (allHiddenKeywords.length > 0) {
                        for (const hiddenTypeObj of allHiddenKeywords) {
                            const matchedHiddenKeywords = hiddenTypeObj.keywords.filter(keyword => text.includes(keyword.toLowerCase()));
                            if (matchedHiddenKeywords.length > 0) {
                                const hiddenKeywordScore = 30;
                                if (!recommendation.hiddenType) recommendation.hiddenType = hiddenTypeObj.type;
                                matchedHiddenKeywords.forEach(keyword => {
                                    if (!recommendation.matchedKeywords.some(mk => mk.keyword.toLowerCase() === keyword.toLowerCase())) {
                                        recommendation.score += hiddenKeywordScore;
                                        recommendation.matchedKeywords.push({ keyword: keyword, score: hiddenKeywordScore, type: 'hidden' });
                                    }
                                });
                            }
                        }
                    }
                    if (recommendation.hiddenType === null && hasComplaintKeyword) {
                        const otherScore = 10;
                        recommendation.score += otherScore;
                        recommendation.hiddenType = 'ê¸°íƒ€';
                        recommendation.matchedKeywords.push({ keyword: 'ê¸°íƒ€', score: otherScore, type: 'hidden' });
                    }
                });
            }
            
            const finalSortedRecommendations = recommendations.sort((a, b) => b.score - a.score);

            if (finalSortedRecommendations.length > 0 && finalSortedRecommendations[0].score > 0) {
                const top3 = finalSortedRecommendations.slice(0, 3);
                document.getElementById('top5Block').style.display = 'block';

                top3.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.className = index === 0 ? 'top5-row rank-1' : 'top5-row';
                    
                    const hiddenBadge = item.hiddenType ? `<span class="hidden-badge">(${item.hiddenType})</span>` : '';
                    
                    const matchedDetails = item.matchedKeywords.map(k => `${k.keyword}(${k.score.toFixed(0)})`).join(', ');

                    tr.innerHTML = `
                        <td align="center">${index + 1}ìœ„</td>
                        <td>
                            <div class="breadcrumb">
                                <b>${item.mainType}</b>
                                <span class="sep">></span>
                                <span>${item.subType}</span>
                                ${hiddenBadge}
                            </div>
                            <div class="score-tooltip">ìƒì„¸ ì ìˆ˜: ${matchedDetails}</div>
                        </td>
                        <td class="score-num">${item.score.toFixed(0)}</td>
                    `;
                    top5Container.appendChild(tr);
                });
            } else {
                document.getElementById('top5Block').style.display = 'none';
            }

            groupedRecommendations.innerHTML = '';
            const mainCategories = [...new Set(data.types.map(item => item.mainType))].sort();
            const grouped = finalSortedRecommendations.reduce((acc, item) => {
                if (!acc[item.mainType]) acc[item.mainType] = [];
                acc[item.mainType].push(item);
                return acc;
            }, {});

            const gridContainer = document.createElement('div');
            gridContainer.className = 'cat-grid';
            groupedRecommendations.appendChild(gridContainer);
            
            const subArea = document.createElement('div');
            groupedRecommendations.appendChild(subArea);

            let subCatWrappers = {};

            mainCategories.forEach(mainType => {
                const catBtn = document.createElement('div');
                const hasScore = grouped[mainType] && grouped[mainType].some(item => item.score > 0);
                
                catBtn.className = `cat-btn ${hasScore ? 'highlighted' : ''} ${selectedMainType === mainType ? 'selected' : ''}`;
                catBtn.innerHTML = `<div>${mainType}</div>`;
                gridContainer.appendChild(catBtn);

                const subWrapper = document.createElement('div');
                subWrapper.className = 'sub-cat-wrapper';
                if(selectedMainType === mainType) subWrapper.style.display = 'block';
                
                data.types.filter(item => item.mainType === mainType).forEach(fullType => {
                    const scoredItem = finalSortedRecommendations.find(item => item.mainType === fullType.mainType && item.subType === fullType.subType);
                    const score = (scoredItem && scoredItem.score > 0) ? scoredItem.score.toFixed(0) : 0;
                    
                    const row = document.createElement('div');
                    row.className = `sub-cat-row ${score > 0 ? 'active' : ''}`;
                    row.innerHTML = `
                        <span>${fullType.subType}</span>
                        <span class="sub-cat-score ${score > 0 ? '' : 'zero'}">${score}</span>
                    `;
                    subWrapper.appendChild(row);
                });
                
                subArea.appendChild(subWrapper);
                subCatWrappers[mainType] = subWrapper;

                catBtn.addEventListener('click', () => {
                    const isClickedAgain = mainType === selectedMainType;
                    
                    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
                    document.querySelectorAll('.sub-cat-wrapper').forEach(w => w.style.display = 'none');

                    if (isClickedAgain) {
                        selectedMainType = null;
                    } else {
                        selectedMainType = mainType;
                        catBtn.classList.add('selected');
                        subCatWrappers[mainType].style.display = 'block';
                    }
                });
            });

            if (!inputArea.textContent.trim()) {
                groupedRecommendations.innerHTML = `
                    <div class="empty-placeholder">
                        <span class="material-icons-sharp" style="font-size:48px; color:#D5D8DC;">assignment_turned_in</span>
                        <br><br>
                        í…ìŠ¤íŠ¸ ë¶„ì„ í›„<br>ìµœì ì˜ ìƒë‹´ ìœ í˜•ì„ í‘œì‹œí•©ë‹ˆë‹¤.
                    </div>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            processInput();
            // PWA Logic
            let deferredPrompt;
            const installPopup = document.getElementById('installPopup');
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installPopup.style.display = 'block'; });
            document.getElementById('confirmInstall').addEventListener('click', () => {
                installPopup.style.display = 'none';
                if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; }
            });
            document.getElementById('cancelInstall').addEventListener('click', () => installPopup.style.display = 'none');
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(() => {});
        });
    </script>
</body>
</html>