<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°€í¬í‹° ê³ ê°ì„¼í„° ë¶ˆë§Œ ê°ì§€ ì‹œìŠ¤í…œ</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        header {
            background: linear-gradient(135deg, #003366, #00509e);
            color: white;
            padding: 20px;
            font-size: 1.8em;
            font-weight: bold;
            border-radius: 0 0 12px 12px;
            text-align: center;
        }
        main {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }
        .notice {
            background-color: #f9fafb;
            border-left: 5px solid #00509e;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .input-area {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            box-sizing: border-box;
            font-size: 0.95em;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
            outline: none;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1em;
            display: none;
        }
        .complaint {
            background-color: #fff0f0;
            border: 1px solid #c0392b;
            color: #c0392b;
        }
        .normal {
            background-color: #e6f4ea;
            border: 1px solid #2e7d32;
            color: #1b5e20;
        }
        .keywords {
            margin-top: 10px;
            font-size: 0.95em;
        }
        .keyword {
            display: inline-block;
            background-color: #ffcccc;
            color: #900;
            padding: 4px 8px;
            margin: 4px;
            border-radius: 4px;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.95em;
        }
        .keyword-desc {
            margin-top: 10px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 6px;
            font-size: 0.9em;
            display: none;
        }
        #securityStatus {
            margin-top: 30px;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
            background-color: #003366;
            color: white;
            padding: 12px 20px;
            border-radius: 0 0 12px 12px;
        }
        #installPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #00509e;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            text-align: center;
        }
        #installPopup button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        #confirmInstall {
            background: #00509e;
            color: white;
        }
        #cancelInstall {
            background: #ccc;
        }
        .type-recommendation {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e6f7ff;
            border: 1px solid #1890ff;
        }
        .type-recommendation h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #00509e;
        }
        .type-recommendation p {
            margin: 5px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>ë°€í¬í‹° ê³ ê°ì„¼í„° ë¶ˆë§Œ ê°ì§€ ì‹œìŠ¤í…œ</header>
        <main>
            <div class="notice">
                ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•˜ë©´, ë¶ˆë§Œìœ¼ë¡œ ì˜ì‹¬ë˜ëŠ” í‘œí˜„ê³¼ í•¨ê»˜ <br>
                ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ <strong>ìƒë‹´ ìœ í˜•(VOC)</strong>ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.
            </div>

            <div id="inputArea" class="input-area" contenteditable="true" spellcheck="false"></div>

            <div id="resultBox" class="result"></div>
            <div id="keywordList" class="keywords"></div>
            <div id="keywordDesc" class="keyword-desc"></div>
            
            <div id="typeRecommendationBox" class="type-recommendation" style="display:none;">
                <h3>ì¶”ì²œ ìƒë‹´ ìœ í˜• (ìƒìœ„ 3ê°œ)</h3>
                <div id="recommendationList"></div>
            </div>
        </main>

        <div id="securityStatus">ğŸ”’ ë³´ì•ˆ ìƒíƒœ: ì•ˆì „ â€” ì™¸ë¶€ ì „ì†¡ ì—†ìŒ</div>
    </div>

    <div id="installPopup">
        <p style="font-size:1.1em; margin-bottom:15px;">ğŸ“² ì´ ì•±ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <button id="confirmInstall">ì„¤ì¹˜</button>
        <button id="cancelInstall">ì·¨ì†Œ</button>
    </div>

    <script>
        const inputArea = document.getElementById('inputArea');
        const resultBox = document.getElementById('resultBox');
        const keywordList = document.getElementById('keywordList');
        const keywordDescBox = document.getElementById('keywordDesc');
        const typeRecommendationBox = document.getElementById('typeRecommendationBox');
        const recommendationList = document.getElementById('recommendationList');

        // ì—‘ì…€ íŒŒì¼ì—ì„œ ì¶”ì¶œí•œ í‚¤ì›Œë“œ ë°ì´í„° (ë¶ˆë§Œ ê°ì§€ìš©)
        const complaintKeywords = [
            "ë¶ˆë§Œ", "ë¶ˆì¾Œ", "í•­ì˜", "ì§œì¦", "ì‹¤ë§", "ë¶ˆì¹œì ˆ",
            "ê¸°ë¶„ ë‚˜ë¹´", "ì–¸ì§¢", "ë¬´ë¡€", "ë¶€ë‹¹", "ê¸°ë¶„ ìƒí–ˆ", "ê°•ì„±",
            "ì‹ ê³ ", "ê²½ì°°", "ì†Œë³´ì›", "ì†Œë¹„ìë³´í˜¸ì›", "ì†Œë¹„ì ë³´í˜¸ì›",
            "ìš•ì„¤", "ìµœì•…", "ë²•ì ëŒ€ì‘"
        ];

        // (ìœ ì§€) ë¶ˆë§Œ í‚¤ì›Œë“œ ì„¤ëª…
        const keywordDescriptions = {
            "ë¶ˆë§Œ": "ì„œë¹„ìŠ¤ë‚˜ ì œí’ˆì— ëŒ€í•œ ì „ë°˜ì ì¸ ë¶ˆë§Œ í‘œí˜„ì…ë‹ˆë‹¤.",
            "ë¶ˆì¾Œ": "ê³ ê°ì´ ê¸°ë¶„ì´ ìƒí•˜ê±°ë‚˜ ë¶ˆì¾Œê°ì„ ëŠë‚€ ìƒí™©ì…ë‹ˆë‹¤.",
            "í•­ì˜": "ë¬¸ì œ ì œê¸°ì™€ í•¨ê»˜ ì‹œì • ìš”êµ¬ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
            "ì§œì¦": "ë¶ˆí¸Â·ë¶ˆë§Œì´ ê°ì •ì ìœ¼ë¡œ í‘œì¶œëœ ìƒíƒœì…ë‹ˆë‹¤.",
            "ì‹¤ë§": "ê¸°ëŒ€ì— ë¯¸ì¹˜ì§€ ëª»í•´ ë¶€ì •ì  í‰ê°€ë¥¼ í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ë¶ˆì¹œì ˆ": "ì‘ëŒ€ íƒœë„ë‚˜ ì„œë¹„ìŠ¤ ë§¤ë„ˆì— ëŒ€í•œ ë¶€ì •ì  í”¼ë“œë°±ì…ë‹ˆë‹¤.",
            "ê¸°ë¶„ ë‚˜ë¹´": "ë°œì–¸Â·í–‰ë™ìœ¼ë¡œ ì¸í•´ ê°ì •ì´ ìƒí•œ ìƒíƒœì…ë‹ˆë‹¤.",
            "ì–¸ì§¢": "ì‚¬ì†Œí•´ ë³´ì´ì§€ë§Œ ë¶ˆë§Œìœ¼ë¡œ ë²ˆì§ˆ ìˆ˜ ìˆëŠ” ê°ì • í‘œí˜„ì…ë‹ˆë‹¤.",
            "ë¬´ë¡€": "ì˜ˆì˜ ì—†ëŠ” íƒœë„ë‚˜ ë°œì–¸ì— ëŒ€í•œ ì§€ì ì…ë‹ˆë‹¤.",
            "ë¶€ë‹¹": "ë¶ˆê³µì •Â·ë¶€ì •í™•í•œ ì²˜ë¦¬ì— ëŒ€í•œ ë¬¸ì œ ì œê¸°ì…ë‹ˆë‹¤.",
            "ê¸°ë¶„ ìƒí–ˆ": "ê³ ê° ê°ì •ì´ í¬ê²Œ ìƒí•œ ìƒíƒœë¡œ, ì§„ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.",
            "ê°•ì„±": "ê°•ê²½í•œ ì–´ì¡°ë¡œ ë¶ˆë§Œì„ ì œê¸°í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì‹ ê³ ": "ì™¸ë¶€ ê¸°ê´€ì— ë¬¸ì œë¥¼ ì•Œë¦¬ê² ë‹¤ëŠ” ì˜ì‚¬ í‘œí˜„ì…ë‹ˆë‹¤.",
            "ê²½ì°°": "ë²•ì Â·í˜•ì‚¬ì  ì¡°ì¹˜ë¥¼ ì•”ì‹œí•˜ëŠ” ë°œì–¸ì…ë‹ˆë‹¤.",
            "ì†Œë³´ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì†Œë¹„ìë³´í˜¸ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ì†Œë¹„ì ë³´í˜¸ì›": "ì†Œë¹„ìë³´í˜¸ì›ì— ì‹ ê³  ì˜ì‚¬ë¥¼ ë°íˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.",
            "ìš•ì„¤": "ë¶€ì ì ˆí•œ ì–¸ì–´ ì‚¬ìš©ìœ¼ë¡œ ê°ì •ì´ ê²©í•´ì§„ ìƒíƒœì…ë‹ˆë‹¤.",
            "ìµœì•…": "ë§¤ìš° ê°•í•œ ë¶€ì • í‰ê°€ë¡œ, ë¶ˆë§Œ ê°•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.",
            "ë²•ì ëŒ€ì‘": "ë²•ì  ì ˆì°¨ë¥¼ ì§„í–‰í•˜ê² ë‹¤ëŠ” ì˜ì‚¬ í‘œí˜„ì…ë‹ˆë‹¤."
        };

        let isComposing = false;
        
        inputArea.addEventListener('compositionstart', () => { isComposing = true; });
        inputArea.addEventListener('compositionend', () => {
            isComposing = false;
            processInput();
        });

        inputArea.addEventListener('input', () => {
            if (!isComposing) {
                processInput();
            }
        });
        
        inputArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!isComposing) {
                    e.preventDefault();
                    document.execCommand('insertLineBreak');
                    processInput();
                }
            }
        });
        
        function processInput() {
            highlightComplaintKeywords();
            analyzeAndRecommendType(); // (ëŒ€ì²´) ML ë°±ì—”ë“œ í˜¸ì¶œ
        }

        // ê¸°ì¡´ ë¶ˆë§Œ í‚¤ì›Œë“œ ê°ì§€ ë° í•˜ì´ë¼ì´íŒ… ê¸°ëŠ¥
        function highlightComplaintKeywords() {
            const caretOffset = getCaretCharacterOffsetWithin(inputArea);
            const rawText = inputArea.textContent;
            let keywordCounts = {};
            let highlightedHtml = '';
            let lastIndex = 0;

            const matches = [...rawText.matchAll(new RegExp(complaintKeywords.join('|'), 'gi'))];
            
            if (matches.length > 0) {
                matches.forEach(match => {
                    const keyword = match[0];
                    const index = match.index;
                    
                    highlightedHtml += escapeHTML(rawText.substring(lastIndex, index));
                    highlightedHtml += `<span style="color:red;">${escapeHTML(keyword)}</span>`;
                    lastIndex = index + keyword.length;

                    keywordCounts[keyword] = (keywordCounts[keyword] || 0) + 1;
                });
                highlightedHtml += escapeHTML(rawText.substring(lastIndex));
                inputArea.innerHTML = highlightedHtml;
                setCaretPosition(inputArea, caretOffset);
                updateUIForComplaintState(keywordCounts);
            } else {
                inputArea.innerHTML = escapeHTML(rawText);
                setCaretPosition(inputArea, caretOffset);
                updateUIForNormalState();
            }
        }
        
        function escapeHTML(text) {
            return text.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
        }

        // í‚¤ì›Œë“œ ë°œê²¬ ì‹œ UI ì—…ë°ì´íŠ¸
        function updateUIForComplaintState(keywordCounts) {
            inputArea.style.border = '1px solid red';
            resultBox.className = 'result complaint';
            resultBox.innerText = 'ğŸš¨ ë¶ˆë§Œ ì˜ì‹¬ í‘œí˜„ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.';
            resultBox.style.display = 'block';

            keywordList.innerHTML = '';
            const foundKeywords = Object.keys(keywordCounts);
            foundKeywords.forEach(k => {
                const span = document.createElement('span');
                span.className = 'keyword';
                span.innerText = `${k}(${keywordCounts[k]})`;
                span.addEventListener('click', () => {
                    keywordDescBox.innerText = `ã€Œ${k}ã€: ${keywordDescriptions[k] || 'ì„¤ëª… ì—†ìŒ'}`;
                    keywordDescBox.style.display = 'block';
                });
                keywordList.appendChild(span);
            });

            const totalCount = Object.values(keywordCounts).reduce((a, b) => a + b, 0);
            const summary = document.createElement('div');
            summary.style.marginTop = '10px';
            summary.style.fontWeight = 'bold';
            summary.style.fontSize = '1.1em';
            summary.textContent = `ì´ ê°ì§€ ë‹¨ì–´ ìˆ˜: ${totalCount}ê°œ`;
            keywordList.appendChild(summary);
        }

        // í‚¤ì›Œë“œ ì—†ì„ ì‹œ UI ì—…ë°ì´íŠ¸
        function updateUIForNormalState() {
            inputArea.style.border = '1px solid #ccc';
            resultBox.className = 'result normal';
            resultBox.innerText = 'âœ… ë¶ˆë§Œ í‘œí˜„ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            resultBox.style.display = 'block';
            keywordList.innerHTML = '';
            keywordDescBox.style.display = 'none';
        }
        
        // (ëŒ€ì²´) ìƒë‹´ ìœ í˜• ì¶”ì²œ: ë¨¸ì‹ ëŸ¬ë‹ ë°±ì—”ë“œ í˜¸ì¶œ
        function analyzeAndRecommendType() {
            const text = inputArea.textContent.trim();
            if (text.length === 0) {
                typeRecommendationBox.style.display = 'none';
                return;
            }

            // ì‹¤ì‹œê°„ í˜¸ì¶œ: localhost:5000/predict
            fetch("http://localhost:5000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            })
            .then(res => res.json())
            .then(data => {
                // data = { major, middle, minor, top3?: [{label, score}] }
                recommendationList.innerHTML = '';
                typeRecommendationBox.style.display = 'block';

                // ìµœìƒìœ„ 1ê°œ(ëŒ€/ì¤‘/ì†Œ)
                const p = document.createElement('p');
                p.textContent = `${data.major} / ${data.middle} / ${data.minor}`;
                recommendationList.appendChild(p);

                // ì„ íƒ: ìƒìœ„ 3ê°œ(ìˆë‹¤ë©´)
                if (Array.isArray(data.top3) && data.top3.length > 0) {
                    data.top3.forEach(item => {
                        const p2 = document.createElement('p');
                        p2.textContent = `${item.label} (${item.score})`;
                        recommendationList.appendChild(p2);
                    });
                }
            })
            .catch(err => {
                console.error("ì˜ˆì¸¡ ì˜¤ë¥˜:", err);
                typeRecommendationBox.style.display = 'none';
            });
        }

        // ê¸°ì¡´ ì»¤ì„œ ìœ„ì¹˜ ê´€ë¦¬ í•¨ìˆ˜ (ìƒëµ ì—†ì´ ìœ ì§€)
        function getCaretCharacterOffsetWithin(element) {
            let caretOffset = 0;
            const doc = element.ownerDocument || element.document;
            const win = doc.defaultView || doc.parentWindow;
            const sel = win.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;
            }
            return caretOffset;
        }

        function setCaretPosition(element, offset) {
            const doc = element.ownerDocument || element.document;
            const win = doc.defaultView || doc.parentWindow;
            const sel = win.getSelection();
            let currentOffset = 0;
            let found = false;

            function traverse(node) {
                if (found) return;
                if (node.nodeType === Node.TEXT_NODE) {
                    const nextOffset = currentOffset + node.length;
                    if (offset <= nextOffset) {
                        const range = doc.createRange();
                        range.setStart(node, offset - currentOffset);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        found = true;
                    }
                    currentOffset = nextOffset;
                } else {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        traverse(node.childNodes[i]);
                        if (found) break;
                    }
                }
            }

            traverse(element);
        }

        // ğŸ”’ ë³´ì•ˆ ìƒíƒœ ê°ì‹œ (ìœ ì§€)
        const statusBox = document.getElementById('securityStatus');
        statusBox.textContent = "ğŸ”’ ë³´ì•ˆ ìƒíƒœ: ì•ˆì „ â€” ì™¸ë¶€ ì „ì†¡ ì—†ìŒ";
        statusBox.style.color = "white";
        statusBox.style.fontSize = "0.9em";

window.fetch = function(...args) {
    const url = args[0];
    if (url.startsWith("http://localhost:5000")) {
        // ë¡œì»¬í˜¸ìŠ¤íŠ¸ëŠ” ì•ˆì „í•˜ê²Œ í—ˆìš©
        return originalFetch.apply(this, args);
    } else {
        statusBox.textContent = "ğŸš¨ ë³´ì•ˆ ê²½ê³ : ì™¸ë¶€ë¡œ ë°ì´í„° ì „ì†¡ ì‹œë„ ê°ì§€ë¨!";
        statusBox.style.backgroundColor = "red";
        statusBox.style.fontSize = "0.9em";
        return originalFetch.apply(this, args);
    }
};

        const originalXHR = window.XMLHttpRequest;
        function MonitorXHR() {
            const xhr = new originalXHR();
            xhr.addEventListener('loadstart', () => {
                statusBox.textContent = "ğŸš¨ ë³´ì•ˆ ê²½ê³ : ì™¸ë¶€ë¡œ ë°ì´í„° ì „ì†¡ ì‹œë„ ê°ì§€ë¨!";
                statusBox.style.backgroundColor = "red";
                statusBox.style.fontSize = "0.9em";
            });
            return xhr;
        }
        window.XMLHttpRequest = MonitorXHR;

        // ğŸ“² ì„¤ì¹˜ ì•ˆë‚´ íŒì—… UI (ìœ ì§€)
        let deferredPrompt;
        const installPopup = document.getElementById('installPopup');
        const confirmInstall = document.getElementById('confirmInstall');
        const cancelInstall = document.getElementById('cancelInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPopup.style.display = 'block';
        });

        window.addEventListener('appinstalled', () => {
            installPopup.style.display = 'none';
        });

        confirmInstall.addEventListener('click', () => {
            installPopup.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choiceResult => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ì•± ì„¤ì¹˜ ì™„ë£Œ');
                    } else {
                        console.log('ì‚¬ìš©ìê°€ ì„¤ì¹˜ë¥¼ ì·¨ì†Œí•¨');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
            }
        });

        cancelInstall.addEventListener('click', () => {
            installPopup.style.display = 'none';
            deferredPrompt = null;
        });

        // âœ… service worker ë“±ë¡ (ìœ ì§€)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('âœ… Service Worker ë“±ë¡ ì™„ë£Œ'))
                .catch(err => console.error('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
        }
    </script>
</body>
</html>